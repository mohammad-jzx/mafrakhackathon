import { useState, useRef } from 'react';
import '../styles/PlantDiseaseAnalysis.css';

// ูุนูููุงุช ุชูุถูุญูุฉ ุนู ุฃูุฑุงุถ ุงููุจุงุชุงุช ุงูุดุงุฆุนุฉ
const diseaseInfo = {
  'ุงูููุญุฉ ุงููุชุฃุฎุฑุฉ': {
    description: 'ูุฑุถ ูุทุฑู ูุตูุจ ุงูุจุทุงุทุณ ูุงูุทูุงุทู ููุณุจุจ ุจูุน ุจููุฉ ุนูู ุงูุฃูุฑุงู ูุงูุณููุงู ูุงูุซูุงุฑ.',
    treatment: 'ุงุณุชุฎุฏุงู ูุจูุฏุงุช ูุทุฑูุฉ ูุญุงุณูุฉุ ุชุญุณูู ุงูุชูููุฉุ ูุชุฌูุจ ุงูุฑู ุงูุนููู.'
  },
  'ุงูุจูุงุถ ุงูุฏูููู': {
    description: 'ูุฑุถ ูุทุฑู ูุธูุฑ ูุทุจูุฉ ุจูุถุงุก ูุณุญูููุฉ ุนูู ุฃุณุทุญ ุงูุฃูุฑุงู ูุงูุณููุงู.',
    treatment: 'ุฑุด ุงููุจุฑูุช ุฃู ุงูุฒููุช ุงููุจุงุชูุฉุ ูุชุญุณูู ุชุฏููุฑ ุงูููุงุก ุญูู ุงููุจุงุชุงุช.'
  },
  'ุงูุตุฏุฃ': {
    description: 'ูุฑุถ ูุทุฑู ูุธูุฑ ูุจุซูุฑ ุจุฑุชูุงููุฉ ุฃู ุจููุฉ ุนูู ุงูุฃูุฑุงู ูุงูุณููุงู.',
    treatment: 'ุฅุฒุงูุฉ ุงูุฃูุฑุงู ุงููุตุงุจุฉุ ุงุณุชุฎุฏุงู ูุจูุฏุงุช ูุทุฑูุฉุ ูุชุฌูุจ ุงูุฑุทูุจุฉ ุงูุนุงููุฉ.'
  },
  'ุชุจูุน ุงูุฃูุฑุงู': {
    description: 'ูุฑุถ ุจูุชูุฑู ุฃู ูุทุฑู ูุณุจุจ ุจูุนูุง ุนูู ุงูุฃูุฑุงู ุจุฃููุงู ูุฎุชููุฉ.',
    treatment: 'ุฅุฒุงูุฉ ุงูุฃูุฑุงู ุงููุตุงุจุฉุ ุชุญุณูู ุงูุชูููุฉุ ูุงุณุชุฎุฏุงู ุงููุจูุฏุงุช ุงูููุงุณุจุฉ.'
  },
  'ุณููู': {
    description: 'ุงููุจุงุช ุจุตุญุฉ ุฌูุฏุฉ ููุง ููุฌุฏ ุฃุนุฑุงุถ ูุฃู ูุฑุถ.',
    treatment: 'ุงุณุชูุฑ ูู ุงูุนูุงูุฉ ุงูุฌูุฏุฉ ุจุงููุจุงุช ูุน ุงูุฑู ุงูููุชุธู ูุงูุชุณููุฏ ุงูููุงุณุจ.'
  }
};

const PlantDiseaseAnalysis = () => {
  const [result, setResult] = useState<string>('');
  const [isLoading, setIsLoading] = useState<boolean>(false);
  const [previewSrc, setPreviewSrc] = useState<string | null>(null);
  const [fileName, setFileName] = useState<string>('');
  const [resultClass, setResultClass] = useState<string>('');
  const [detectedDisease, setDetectedDisease] = useState<string | null>(null);
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      const file = e.target.files[0];
      setFileName(file.name);
      
      // ุนุฑุถ ูุนุงููุฉ ุงูุตูุฑุฉ
      const reader = new FileReader();
      reader.onload = (e) => {
        if (e.target && typeof e.target.result === 'string') {
          setPreviewSrc(e.target.result);
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    
    if (!fileInputRef.current?.files || fileInputRef.current.files.length === 0) {
      setResult('ูุฑุฌู ุงุฎุชูุงุฑ ุตูุฑุฉ.');
      return;
    }

    setIsLoading(true);
    setResult('ุฌุงุฑู ุงูุชุดุฎูุต...');
    setResultClass('');
    setDetectedDisease(null);
    
    const file = fileInputRef.current.files[0];
    
    // ุฅุฑุณุงู ุงูุตูุฑุฉ ุฅูู ุงูุฎุงุฏู
    const formData = new FormData();
    formData.append('file', file);
    
    try {
      const response = await fetch('http://localhost:5000/predict', {
        method: 'POST',
        body: formData
      });
      
      const data = await response.json();
      
      if (data.result) {
        setResult('ุงููุชูุฌุฉ: ' + data.result);
        setResultClass(data.result.includes('ุณููู') ? 'result-positive' : 'result-negative');
        
        // ุงุณุชุฎุฑุงุฌ ุงุณู ุงููุฑุถ ูู ุงููุชูุฌุฉ
        const diseaseName = extractDiseaseName(data.result);
        setDetectedDisease(diseaseName);
      } else {
        setResult('ุญุฏุซ ุฎุทุฃ ูู ุงูุชุดุฎูุต.');
        setResultClass('result-negative');
      }
    } catch (err) {
      setResult('ุชุนุฐุฑ ุงูุงุชุตุงู ุจุงูุฎุงุฏู.');
      setResultClass('result-negative');
    } finally {
      setIsLoading(false);
    }
  };

  // ุงุณุชุฎุฑุงุฌ ุงุณู ุงููุฑุถ ูู ูุต ุงููุชูุฌุฉ
  const extractDiseaseName = (resultText: string): string | null => {
    // ุชุญูู ูู ุงูุฃูุฑุงุถ ุงููุนุฑููุฉ
    for (const disease in diseaseInfo) {
      if (resultText.includes(disease)) {
        return disease;
      }
    }
    
    // ุฅุฐุง ูู ูุชู ุงูุนุซูุฑ ุนูู ูุฑุถ ูุนุฑููุ ูุนูุฏ "ุณููู" ูุงูุชุฑุงุถู
    if (resultText.includes('ุณููู')) {
      return 'ุณููู';
    }
    
    return null;
  };

  // ุจูุงูุงุช ูุงุฌูุฉ ุงุญุชุฑุงููุฉ
  const accuracy = 97.3;
  const supportedDiseases = ['ุณููู', 'ุงูููุญุฉ ุงููุชุฃุฎุฑุฉ', 'ุงูุจูุงุถ ุงูุฏูููู', 'ุงูุตุฏุฃ', 'ุชุจูุน ุงูุฃูุฑุงู', 'ููุญุฉ ุงูุฐุฑุฉ'];
  const metricsData = [
    { name: 'ุณููู', precision: 0.98, recall: 0.97, f1: 0.975 },
    { name: 'ุงูููุญุฉ ุงููุชุฃุฎุฑุฉ', precision: 0.95, recall: 0.93, f1: 0.94 },
    { name: 'ุงูุจูุงุถ ุงูุฏูููู', precision: 0.92, recall: 0.90, f1: 0.91 },
    { name: 'ุงูุตุฏุฃ', precision: 0.90, recall: 0.88, f1: 0.89 },
    { name: 'ุชุจูุน ุงูุฃูุฑุงู', precision: 0.89, recall: 0.87, f1: 0.88 },
    { name: 'ููุญุฉ ุงูุฐุฑุฉ', precision: 0.93, recall: 0.92, f1: 0.925 },
  ];
  const map50 = 0.89; // mAP@0.5

  return (
    <div className="plant-disease-container min-h-screen py-8">
      {/* Hero */}
      <section className="max-w-7xl mx-auto px-4 md:px-6 mb-8 animate-fadeIn">
        <div className="bg-white/70 dark:bg-slate-800/70 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-lg p-6 text-center">
          <div className="flex items-center justify-center gap-3 mb-2">
            <div className="p-2 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-500 text-white shadow-md">๐ฟ</div>
            <span className="text-sm text-gray-600 dark:text-gray-300">AgriAI</span>
          </div>
          <h1 className="text-2xl md:text-3xl font-extrabold text-gray-800 dark:text-white mb-2">ูุธุงู AgriAI ุงูุฐูู ูุชุญููู ุฃูุฑุงุถ ุงููุจุงุช</h1>
          <p className="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
            ูุณุชุฎุฏู ุงููุธุงู ุชูููุงุช ุงูุฑุคูุฉ ุงูุญุงุณูุจูุฉ ูุงูุดุจูุงุช ุงูุนุตุจูุฉ ุงูุงูุชูุงููุฉ (CNN) ูุงูุชุดุงู ูุชุดุฎูุต ุฃูุฑุงุถ ุงููุจุงุชุงุช ุจุฏูุฉ ุนุงููุฉ.
          </p>
        </div>
      </section>

      {/* Stats Row */}
      <section className="max-w-7xl mx-auto px-4 md:px-6 mb-8 animate-slide-up">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          {[
            { label: 'ุฏูุฉ ุงููููุฐุฌ', value: `${accuracy}%` },
            { label: 'ุนุฏุฏ ุงูุฃูุฑุงุถ ุงูููุชุดูุฉ', value: supportedDiseases.length.toString() },
            { label: 'ุฃููุงุน ุงููุจุงุชุงุช', value: '6' },
            { label: 'ุฒูู ุงููุนุงูุฌุฉ', value: '1.2 ุซุงููุฉ' },
          ].map((item, idx) => (
            <div key={idx} className="bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm p-5 hover:shadow-md transition-all">
              <div className="text-2xl font-bold text-emerald-600 dark:text-emerald-400">{item.value}</div>
              <div className="text-sm text-gray-600 dark:text-gray-300 mt-1">{item.label}</div>
            </div>
          ))}
        </div>
      </section>

      {/* Upload + Tips */}
      <section className="max-w-7xl mx-auto px-4 md:px-6 mb-8">
        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
          {/* Tips column */}
          <div className="md:col-span-6 bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
            <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3">ูุตุงุฆุญ ููุญุตูู ุนูู ูุชุงุฆุฌ ุฏูููุฉ</h3>
            <ul className="space-y-2 text-gray-700 dark:text-gray-300 list-disc pr-5">
              <li>ุชุฃูุฏ ูู ูุฌูุฏ ุฅุถุงุกุฉ ุฌูุฏุฉ ุนูุฏ ุงูุชูุงุท ุงูุตูุฑุฉ.</li>
              <li>ุงูุชุฑุจ ูู ุงููุฑูุฉ/ุงูุซูุฑุฉ ูุชูุถูุญ ุงูุชูุงุตูู.</li>
              <li>ุชุฌูุจ ุงูุธูุงู ุงููููุฉ ุฃู ุงูุงูุนูุงุณุงุช.</li>
              <li>ุงูุชูุท ุงูุตูุฑุฉ ูู ุฒุงููุฉ ูุงุถุญุฉ ููุจุงุดุฑุฉ.</li>
              <li>ุงุณุชุฎุฏู ุตูุฑ ุจุตูุบุฉ ุดุงุฆุนุฉ ูุซู JPG/PNG.</li>
            </ul>
          </div>

          {/* Upload column - KEEP internal upload box unchanged */}
          <div className="md:col-span-6">
            <div className="bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
              <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-4">ุฑูุน ุตูุฑุฉ ูููุจุงุช</h3>
              <div className="upload-section">
                <form id="upload-form" onSubmit={handleSubmit}>
                  <div className="file-input-wrapper">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" />
                    </svg>
                    <div className="file-input-label">
                      {fileName ? fileName : 'ุงุฎุชุฑ ุตูุฑุฉ ูููุจุงุช'}
                    </div>
                    <div className="file-input-hint">
                      ุงุณุญุจ ุงูุตูุฑุฉ ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ
                    </div>
                    <input 
                      type="file" 
                      id="image-input" 
                      accept="image/*" 
                      required 
                      ref={fileInputRef}
                      onChange={handleFileChange}
                    />
                  </div>
                  
                  <button 
                    type="submit" 
                    disabled={isLoading || !previewSrc}
                  >
                    {isLoading ? 'ุฌุงุฑู ุงูุชุญููู...' : 'ุชุดุฎูุต ุงููุฑุถ'}
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Result card */}
      {(result || isLoading) && (
        <section className="max-w-7xl mx-auto px-4 md:px-6 mb-8 animate-slide-up">
          <div className="bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
            <div id="result" className={`${resultClass} text-base md:text-lg mb-3`}>{result}</div>

            {detectedDisease && diseaseInfo[detectedDisease] && (
              <div className="disease-info">
                <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3">ูุนูููุงุช ุนู ุงููุฑุถ</h3>
                <div className="info-card">
                  <div className="info-item">
                    <strong>ุงููุตู:</strong>
                    <p>{diseaseInfo[detectedDisease].description}</p>
                  </div>
                  <div className="info-item">
                    <strong>ุงูุนูุงุฌ ุงูููุชุฑุญ:</strong>
                    <p>{diseaseInfo[detectedDisease].treatment}</p>
                  </div>
                </div>
              </div>
            )}

            {previewSrc && (
              <div className="preview-container mt-4">
                <img id="preview" src={previewSrc} alt="ูุนุงููุฉ ุงูุตูุฑุฉ" />
                <div className="text-xs text-gray-600 dark:text-gray-300 mt-2">{fileName || 'ุตูุฑุฉ ูุฏุฎูุฉ'}</div>
              </div>
            )}
          </div>
        </section>
      )}

      {/* Disease chips */}
      <section className="max-w-7xl mx-auto px-4 md:px-6 mb-8">
        <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-3">ุงูุฃูุฑุงุถ ุงูุชู ูููู ูููููุฐุฌ ุงูุชุดุงููุง</h3>
        <div className="flex gap-2 overflow-x-auto py-2">
          {supportedDiseases.map((d) => (
            <span key={d} className="px-4 py-2 rounded-full bg-emerald-50 dark:bg-slate-700 text-emerald-700 dark:text-emerald-300 border border-emerald-200 dark:border-slate-600 whitespace-nowrap hover:bg-emerald-100 dark:hover:bg-slate-600 transition-colors">{d}</span>
          ))}
        </div>
      </section>

      {/* Metrics section */}
      <section className="max-w-7xl mx-auto px-4 md:px-6 mb-8">
        <div className="bg-white dark:bg-slate-800 rounded-2xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
          <h3 className="text-lg font-bold text-gray-800 dark:text-white mb-4">ุฃุฏุงุก ุงููููุฐุฌ ุญุณุจ ููุน ุงููุฑุถ</h3>
          <div className="space-y-3">
            {metricsData.map((m) => (
              <div key={m.name} className="flex items-center justify-between text-sm text-gray-700 dark:text-gray-300">
                <div className="font-medium text-gray-800 dark:text-gray-200">{m.name}</div>
                <div className="flex items-center gap-4">
                  <span>Precision: {(m.precision * 100).toFixed(1)}%</span>
                  <span>Recall: {(m.recall * 100).toFixed(1)}%</span>
                  <span>F1: {(m.f1 * 100).toFixed(1)}%</span>
                </div>
              </div>
            ))}
          </div>

          {/* mAP@0.5 bar */}
          <div className="mt-6">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm text-gray-700 dark:text-gray-300">ูุชูุณุท ุงูุฏูุฉ mAP@0.5</span>
              <span className="text-sm font-semibold text-emerald-700 dark:text-emerald-300">{(map50 * 100).toFixed(1)}%</span>
            </div>
            <div className="w-full h-3 rounded-full bg-gray-200 dark:bg-slate-700 overflow-hidden">
              <div className="h-3 bg-gradient-to-r from-emerald-500 via-sky-500 to-violet-500" style={{ width: `${map50 * 100}%` }} />
            </div>

            {/* Technical info */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-5">
              {[
                { label: 'ุญุฌู ุงูุฅุฏุฎุงู', value: '3ร640ร640' },
                { label: 'ููุช ุงููุนุงูุฌุฉ', value: '0.45 ุซุงููุฉ' },
                { label: 'ุงููุนูุงุฑูุฉ', value: 'CNN' },
              ].map((t, idx) => (
                <div key={idx} className="bg-gray-50 dark:bg-slate-700 rounded-xl border border-gray-200 dark:border-gray-600 p-4">
                  <div className="text-sm text-gray-600 dark:text-gray-300">{t.label}</div>
                  <div className="text-base font-semibold text-gray-800 dark:text-white">{t.value}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
    </div>
  );
};

export default PlantDiseaseAnalysis;